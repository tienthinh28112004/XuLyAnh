<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Demo Bộ lọc ảnh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap: 16px; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; color: #222; }
    h2 { margin: 0 0 12px; font-weight: 700; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }

    .layout {
      display: grid;
      grid-template-columns: 330px 1fr 1fr;
      gap: var(--gap);
      align-items: start;
    }

    .panel { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 14px; height: 100%; box-sizing: border-box; }
    .panel h3 { margin: 0 0 10px; font-size: 1rem; }

    label { display: block; margin: 6px 0; }
    select, input[type="file"], input[type="number"], button {
      padding: 8px 10px; border-radius: 8px; border: 1px solid #d1d5db; width: 100%;
    }
    button { cursor: pointer; background: #111827; color: #fff; border: none; font-weight: 600; }
    button:hover { background: #0f172a; }

    .small { color:#6b7280; font-size: 12px; line-height: 1.4; }
    .flash { color:#b91c1c; margin: 6px 0 0; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .hide { display:none; }

    /* Ảnh hiển thị cân khung */
    .figure { display: flex; flex-direction: column; gap: 8px; height: 100%; }
    .figure h4 { margin: 0; text-align: center; font-weight: 600; }
    .imgwrap {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 10px;
      overflow: hidden;
      height: 420px; /* chỉnh khung vừa mắt */
    }
    .imgwrap img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* không méo hình */
    }

    /* Responsive nhỏ hơn 1100px thì xếp dọc */
    @media (max-width: 1100px) {
      .layout { grid-template-columns: 1fr; }
      .imgwrap { height: auto; }
    }
  </style>
</head>
<body>
  <h2>Nghiệm thu: Chọn bộ lọc → Tải ảnh/CSV → Xem kết quả trực quan</h2>
  <div class="card">

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash">
          {% for m in messages %}<div>• {{ m }}</div>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="layout">
      <!-- Cột 1: bộ lọc + dữ liệu -->
      <div class="panel">
        <form method="post" enctype="multipart/form-data" id="filterForm">
          <h3>1) Chọn bộ lọc</h3>
          <label for="filter">Bộ lọc</label>
          <select name="filter" id="filter" required>
            {% for key, pair in filters.items() %}
              <option value="{{ key }}" {% if key==selected %}selected{% endif %}>{{ pair[0] }}</option>
            {% endfor %}
          </select>
          <p class="small" style="margin-top:6px">• Mean / Gaussian / Median (làm mịn) — Sobel / Prewitt / Laplacian (biên).</p>

          <hr style="border:none;border-top:1px dashed #e5e7eb; margin:12px 0">

          <h3>2) Chọn dữ liệu</h3>
          <label for="mode">Nguồn</label>
          <select name="mode" id="mode">
            <option value="image" selected>Ảnh (JPG/PNG)</option>
            <option value="csv">CSV (ma trận ảnh)</option>
          </select>

          <label style="margin-top:8px">Tệp đầu vào</label>
          <input type="file" name="file" accept=".png,.jpg,.jpeg,.bmp,.csv" required>

          <div id="csvDims" class="grid2 hide" style="margin-top:8px">
            <div>
              <label>H (chiều cao)
                <input type="number" name="height" min="1" placeholder="vd 256">
              </label>
            </div>
            <div>
              <label>W (chiều rộng)
                <input type="number" name="width" min="1" placeholder="vd 256">
              </label>
            </div>
          </div>

          <button type="submit" style="margin-top:12px">Xử lý</button>
          <p class="small" style="margin-top:8px">
            * Nếu CSV dạng phẳng (1×N), hãy nhập H×W để reshape.  
            * Các bộ lọc 3×3 kiểu “valid” có thể làm ảnh nhỏ hơn 2px mỗi chiều.
          </p>
        </form>
      </div>

      <!-- Cột 2: ảnh gốc -->
      <div class="panel figure">
        <h4>Ảnh gốc (giữ nguyên như tải lên)</h4>
        <div class="imgwrap">
          {% if src_url %}
            <img src="{{ src_url }}" alt="original">
          {% else %}
            <div class="small" style="padding:16px; text-align:center">Chưa có ảnh gốc — hãy chọn bộ lọc và tải ảnh/CSV rồi bấm "Xử lý".</div>
          {% endif %}
        </div>
      </div>

      <!-- Cột 3: ảnh sau lọc -->
      <div class="panel figure">
        <h4>Ảnh sau lọc</h4>
        <div class="imgwrap">
          {% if out_url %}
            <img src="{{ out_url }}" alt="filtered">
          {% else %}
            <div class="small" style="padding:16px; text-align:center">Chưa có ảnh sau lọc.</div>
          {% endif %}
        </div>
        {% if note %}<div class="small" style="text-align:center">{{ note }}</div>{% endif %}
      </div>
    </div>
  </div>

  <script>
    const modeSel = document.getElementById('mode');
    const csvDims = document.getElementById('csvDims');
    function toggleCsvDims() {
      csvDims.classList.toggle('hide', modeSel.value !== 'csv');
    }
    modeSel.addEventListener('change', toggleCsvDims);
    toggleCsvDims();
  </script>
</body>
</html>
